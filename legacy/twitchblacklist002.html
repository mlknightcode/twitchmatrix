<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Twitch Matrix Generator</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #222;
    color: #fff;
    padding: 20px;
    margin: 0;
  }
  .container {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
  }
  .online { color: lime; }
  .offline { color: red; }
  .unknown { color: gray; }
  .blacklisted {
    text-decoration: line-through;
    opacity: 0.5;
  }
  .button-row {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin: 20px 0;
    flex-wrap: wrap;
  }
  .grid {
    display: flex;
    justify-content: center;
    gap: 30px;
    margin-top: 20px;
    flex-wrap: wrap;
  }
  .tier {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
  }
  .tier h3 {
    text-align: center;
    margin-bottom: 10px;
  }
  .streamer { margin: 2px 0; }
  .status {
    margin-top: 20px;
    text-align: center;
  }
  button {
    padding: 10px 20px;
    font-size: 16px;
    background-color: #9146FF;
    color: white;
    border: none;
    cursor: pointer;
  }
  button:disabled {
    background-color: #555;
    cursor: not-allowed;
  }
  button:hover:enabled {
    background-color: #772ce8;
  }
  label {
    margin: 0 10px;
  }
  input[type="text"] {
    padding: 5px;
    width: 80px;
  }
</style>
</head>
<body>
<div class="container">
  <h1>Twitch Matrix</h1>
  <p>Finds live streamers and shows TwitchTheater and MultiTwitch links.</p>

  <div class="button-row">
    <label>Size: <input type="text" id="inputSize" value="6"></label>
    <label>Limits (4 digits): <input type="text" id="inputLimits" value="6000" maxlength="4"></label>
    <label>Blacklist: <input type="text" id="inputBlacklist" placeholder="comma,separated"></label>
  </div>
  <div class="button-row">
    <label><input type="checkbox" id="rand1"> Random Tier 1</label>
    <label><input type="checkbox" id="rand2"> Random Tier 2</label>
    <label><input type="checkbox" id="rand3"> Random Tier 3</label>
    <label><input type="checkbox" id="rand4"> Random Tier 4</label>
    <button id="generateBtn">Generate</button>
  </div>
  <div class="button-row">
    <button disabled id="openLink">Open TwitchTheater</button>
    <button disabled id="openMulti">Open MultiTwitch</button>
  </div>
</div>

<div class="grid" id="gridContainer"></div>
<div class="status" id="status">Ready to check streamers...</div>

<script>
const tier1 = [ "jinnytty","extraemily","bonnie","qtcinderella","emiru","knut","onigiri","mhyochi","jaystreazy","waterlynn","jakenbakelive","lo3tus","rennsz","hachubby","crispyjenny","jellyhaeni","hazunats","aprylanonymous","potentialbliss","hippiefix","ibabyrainbow","magicallyconsumed","recharg_ing","chloe__irl","kumamonster","dinomitetwins","nezst","jonsf","daveezz","studytme","jengo_m","ninthchild","bawnsai","ira_aba","justketh" ];
const tier2 = [ "yoshimyan","mizkif","juliakins","lizzy_senrose","cherlosthome","hello_kiko","fuslie","hitch","sarahbridgewater","therealshookon3","4amlaundry","nessalpaca","rellik","clararline","melibela","arrav","cooksux","meesterkeem","soleastellaa","globiklive","manukiemi","misterarther","cinna","robcdee","ridetheline","poultry_motion","fido_tw","d3nduro","stephaniequatro","foxiekt","classic_christine","wasabiicat","lychee","kiwhiskey" ];
const tier3 = [ "dskoopa","voyagesdiary","tiffanobi","gaijin1up","nomadicgaijin","yubababoo","thecranecouple","cybersteffie","gogoborgor","terrybarentsen","sahranisworld","miki_tokyo","claraatwork","mrpol","barktok","missmikkaa","nmplol","ppim","zumi","kydeanderic","botezlive","danioskam","crunk_muffin","architecturetv" ];
const tier4 = [ "maimaittv","wolfsbanee","soweq","tymwits","jinritv","relit20","awkwards_travel","crack_eggs","miekii","0greprincess","bottlehead","yurijoa","igumdrop","henukei","liniwalks","cecehustle","tokidokitraveller","w3cj","arianakatana","slipstreamjc","retrogaijin","dizzykitten","donutkingtv","zep_aki","agctv","hapipy","eddy2travel","mewmelodys" ];
const tiers = [tier1, tier2, tier3, tier4];

const clientId = "kimne78kx3ncx6brgo4mv6wki5h1ko";
const query = `query($login: String!) {
  user(login: $login) {
    stream { id }
  }
}`;

const gridContainer = document.getElementById("gridContainer");
const statusEl = document.getElementById("status");
const openBtn = document.getElementById("openLink");
const multiBtn = document.getElementById("openMulti");
const generateBtn = document.getElementById("generateBtn");

let finalURL = "";
let multiURL = "";

function setupGrid() {
  gridContainer.innerHTML = "";

  const blacklistRaw = document.getElementById("inputBlacklist")?.value || "";
  const blacklist = new Set(blacklistRaw.split(",").map(s => s.trim().toLowerCase()).filter(Boolean));

  tiers.forEach((tier, index) => {
    const tierDiv = document.createElement("div");
    tierDiv.className = "tier";
    const heading = document.createElement("h3");
    heading.textContent = `Tier ${index + 1}`;
    tierDiv.appendChild(heading);

    tier.forEach(name => {
      const span = document.createElement("span");
      span.textContent = name;
      span.id = `status-${name}`;
      span.className = "streamer unknown";
      if (blacklist.has(name.toLowerCase())) {
        span.classList.add("blacklisted");
      }
      tierDiv.appendChild(span);
    });

    gridContainer.appendChild(tierDiv);
  });
}

function shuffledCopy(arr) {
  return [...arr]
    .map(value => ({ value, sort: Math.random() }))
    .sort((a, b) => a.sort - b.sort)
    .map(({ value }) => value);
}

async function fetchLiveStatus(name) {
  const res = await fetch("https://gql.twitch.tv/gql", {
    method: "POST",
    headers: {
      "Client-ID": clientId,
      "Content-Type": "application/json"
    },
    body: JSON.stringify([{ operationName: null, query, variables: { login: name } }])
  });
  const data = await res.json();
  return data[0]?.data?.user?.stream !== null;
}

async function checkStreamers() {
  const size = parseInt(document.getElementById("inputSize").value || "6", 10);
  const limitsRaw = document.getElementById("inputLimits").value || "6000";
  const tierLimits = limitsRaw.padEnd(4, "0").slice(0, 4).split("").map(n => parseInt(n, 10));
  const tierRandomize = [
    document.getElementById("rand1").checked,
    document.getElementById("rand2").checked,
    document.getElementById("rand3").checked,
    document.getElementById("rand4").checked
  ];
  const blacklistRaw = document.getElementById("inputBlacklist")?.value || "";
  const blacklist = new Set(blacklistRaw.split(",").map(s => s.trim().toLowerCase()).filter(Boolean));

  const live = [];
  const usedTiers = [];
  const tierLiveCounts = [0, 0, 0, 0];
  const alreadyChecked = new Set();
  statusEl.innerHTML = "";

  tiers.flat().forEach(name => {
    const span = document.getElementById(`status-${name}`);
    if (span && !span.classList.contains("blacklisted")) {
      span.className = "streamer unknown";
    }
  });

  outerLoop:
  for (let i = 0; i < tiers.length; i++) {
    const tier = tiers[i];
    const limit = tierLimits[i];
    const checkList = tierRandomize[i] ? shuffledCopy(tier) : tier;

    for (const name of checkList) {
      if (blacklist.has(name.toLowerCase())) continue;
      if (tierLiveCounts[i] >= limit) break;
      const isLive = await fetchLiveStatus(name);
      alreadyChecked.add(name);
      const span = document.getElementById(`status-${name}`);
      if (span) span.className = `streamer ${isLive ? "online" : "offline"}`;
      if (isLive) {
        tierLiveCounts[i]++;
        if (!usedTiers.includes(`Tier ${i + 1}`)) usedTiers.push(`Tier ${i + 1}`);
        live.push(name);
      }
      if (live.length >= size) break outerLoop;
    }
  }

  if (live.length < size) {
    for (let i = 0; i < tiers.length; i++) {
      const tier = tiers[i];
      const checkList = tierRandomize[i] ? shuffledCopy(tier) : tier;
      for (const name of checkList) {
        if (alreadyChecked.has(name) || blacklist.has(name.toLowerCase())) continue;
        const isLive = await fetchLiveStatus(name);
        alreadyChecked.add(name);
        const span = document.getElementById(`status-${name}`);
        if (span) span.className = `streamer ${isLive ? "online" : "offline"}`;
        if (isLive) {
          live.push(name);
          if (!usedTiers.includes(`Tier ${i + 1}`)) usedTiers.push(`Tier ${i + 1}`);
          if (live.length >= size) break;
        }
      }
      if (live.length >= size) break;
    }
  }

  if (live.length) {
    finalURL = `https://twitchtheater.tv/${live.join("/")}`;
    multiURL = `https://multitwitch.tv/${live.join("/")}`;
    openBtn.disabled = false;
    multiBtn.disabled = false;
    statusEl.innerHTML = `<br><strong>Streamers pulled from: ${usedTiers.join(", ")}</strong>`;
  } else {
    statusEl.innerHTML = "<br>No live streamers found.";
  }
}

// Wire up buttons
generateBtn.onclick = () => checkStreamers();
openBtn.onclick = () => { if (finalURL) window.open(finalURL, "_blank"); };
multiBtn.onclick = () => { if (multiURL) window.open(multiURL, "_blank"); };

// Show initial grid
setupGrid();

// Update grid when blacklist changes
document.getElementById("inputBlacklist").addEventListener("input", setupGrid);
</script>
</body>
</html>
